<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta charset="utf-8">

    <title>Connected Car: VID 38 on the road </title>
    <!-- Add bootstrap -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.css" />

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />


    <!-- Customized CSS -->
    <link href="src/multiple-select.css" rel="stylesheet"/>
    <!-- ref: http://www.bootply.com/FkGBM2gvKt -->
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      
      #map-canvas { 
        /* height: 100%  */
        width:82.6333%;
        height:100%;
        position:absolute;
        left:0px;
        /* top:50px; */
        bottom:0;
        overflow:hidden;
      }
      
      #pac-input {
        background-color: #fff;
        padding: 0 11px 0 13px;
        width: 400px;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        text-overflow: ellipsis;
      }
    
      #pac-input:focus {
        border-color: #4d90fe;
        margin-left: -1px;
        padding-left: 14px;  /* Regular padding-left + 1. */        
        width: 401px;
      }
      

      
      .pac-container {
        font-family: Roboto;
      }
      
      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }

      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
    </style>

   
    <!-- Add Google map API-->
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyAp1w_hIM2WIqXnf0j0Dk4hGBfgZHsIdKA&libraries=places,geometry">
    </script>

    <script type="text/javascript"> /* Google map setting */
      function initialize() {
        var savedRoute ={};

        var mapOptions = {
            center: new google.maps.LatLng(42.518, -83.644),
            zoom: 10
          };

        var map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);

        /* Read gps data from a JSON file */
        
        function loadJSON(filepath){
          return $.getJSON(filepath).done(function(data){
             return data.items;
          })
        }

        var gps38 = "https://dl.dropboxusercontent.com/u/6964160/gps38route.json";
        var tripids = [];



        function drawRoute(){
          console.log("what's pass to drawRoute");
          console.log(savedRoute);

          for (var t in savedRoute){
            console.log("drawROute loop");
            var trip = savedRoute[t];



            path = new google.maps.Polyline({
              path: savedRoute[t]['steps'],
              geodesic: true,
              strokeColor: '#01296E',
              strokeOpacity: 1.0,
              strokeWeight: 2,
              map: map,
              title: savedRoute[t]['tripid']
      
            }); 


  

            var startMarker = new google.maps.Marker({
              position: savedRoute[t]['steps'][0],
              map: map,

            });

            var infowindow =  new google.maps.InfoWindow({
              content: savedRoute[t]['tripid']
            });

            infowindow.open(map,startMarker);

            google.maps.event.addListener(startMarker, 'click', function() {
              moveTheCar(pathMarker,savedRoute[t]['steps'],0);
            });

            

          }; // each route 

        };//End of drawRoute

        

        function showSelinfo(checkedRoute, show){

          loadJSON(gps38).done(function(obj){

            console.log(obj);
            console.log(typeof(checkedRoute));
            //tripids = Object.keys(obj); // return Keys in an object
            //Convert points into Google LatLng format

            //for (var r=0; r <selectedRoute.length; r++){
            //  var tripid = selectedRoute[r]; 
            //  console.log(tripid);

            
            var googleLatlng = [];
           
            for (var i=0, point; point = obj[checkedRoute]['steps'][i]; i++ ){
              if (i < obj[checkedRoute]['steps'].length){
                var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                googleLatlng.push(latLng);              
              }
            }; // End of forloop for one tripid
            

            var startPoint = obj[checkedRoute]['steps'][0];
            var tripinfo = checkedRoute + ": "+obj[checkedRoute]['startDate']+", " + obj[checkedRoute]['startTime'];
            console.log(tripinfo);

         
            var startMarker = new google.maps.Marker({
              position: new google.maps.LatLng(startPoint['lat'],startPoint['lon']),
              map: map,

            });

            var infowindow =  new google.maps.InfoWindow({
              content: tripinfo
              });
            infowindow.open(map,startMarker);
            

            
            google.maps.event.addListener(startMarker, 'click', function() {
              moveTheCar(pathMarker,googleLatlng,0);
            });
            
            //drawRoute(googleLatlng);               
           
           
          }); // End of loadJSON
        }; // End of showSelectedRoute



        function addSelRoute(checkedRoute){          
          loadJSON(gps38).done(function(obj){
            var googleLatlng = [];  
            // Convert into google map latLng
            for (var i=0, point; point = obj[checkedRoute]['steps'][i]; i++ ){
              if (i < obj[checkedRoute]['steps'].length){
                var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                googleLatlng.push(latLng);              
              }
            };

            startPoint = obj[checkedRoute]['steps'][0];
            var tripinfo = (checkedRoute + ": " + obj[checkedRoute]['startDate'] + ", " + obj[checkedRoute]['startTime'] ); 

            savedRoute[checkedRoute] = {};
            savedRoute[checkedRoute]['tripid'] = checkedRoute;
            savedRoute[checkedRoute]['steps'] = googleLatlng;
            savedRoute[checkedRoute]['tripinfo'] = tripinfo;
            //savedRoute[checkedRoute]['startPoint'] = startPoint;

          console.log("added route - Indide?");
          console.log(savedRoute);

          });// End of loadJSON    

          console.log("added route - Outside?");
          console.log(savedRoute);


        }; //End of saveSelRoute
          
        function rmSelRoute(uncheckedRoute){
          delete savedRoute[uncheckedRoute];
          
        };

        /* Selected VID 
        /* jQuery template: http://wenzhixin.net.cn/p/multiple-select/docs 
        */

        console.log("before I click");
        console.log(savedRoute);

        $("select").multipleSelect({
          
          filter: true,
          multiple: true,
          width: '100%',
          placeholder: "Select VID and route",

          onClick: function(view){
            // TODO: fet VID by tripid?????
            
            if (view.checked) {
              console.log("what I clicked");
              console.log(view.value);
              addSelRoute(view.value);
              console.log("what's saved 2");
              console.log(savedRoute);
              drawRoute();

              
              //showSelinfo(view.value);
              } 
            else{
              rmSelRoute(view.value);
            };

            //console.log((view.value));
            //showSelectedRoute(view.value);
            console.log("what's saved 1");
            console.log(savedRoute);
            drawRoute();
            


          }, // End of onClick

          onOptgroupClick: function(view) {
              var values = $.map(view.children, function(child){
                  return child.value;
              }).join(', ');
              //checkedRoute['tripids'] = values;
          }


            //showSelectedRoute(checkedRoute);
         });

        /* Add infowindow when the marker is clicked       
        var infowindow =  new google.maps.InfoWindow({
          content: "470: 2014/4/1 18:04:12"
        });
 */   
        /*
        var startMarker = new google.maps.Marker({
          position:gpsdict[0],
          map: map,
          title: "Start Here"
        });
        infowindow.open(map,startMarker);
        */

        /* Static path 
        var route = new google.maps.Polyline({
          path: gpsdict,
          geodesic: true,
          strokeColor: '#000000',
          strokeOpacity: 1.0,
          strokeWeight: 2,
          map: map
        });
        */

        /* Animated path 
        var pathMarker = new google.maps.Marker({
          position: gpsdict[0],
          map: map,
          icon: 'src/img/car-icon.png'
        });

*/


        /* Add search box */

        var input = /** @type {HTMLInputElement} */(document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
        
        var searchBox = new google.maps.places.SearchBox(/** @type {HTMLInputElement} */(input));

        // [START region_getplaces]
        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
       

        google.maps.event.addListener(searchBox, 'places_changed', function() {
          var places = searchBox.getPlaces();   // an object
          var placeMarkers = [];


          if (places.length == 0) {
            return;
          }
          
          for (var i = 0, marker; marker = placeMarkers[i]; i++) {
            marker.setMap(null);
          }

          // For each place, get the icon, place name, and location.

          placeMarkers = [];
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            var image = {
                          url: place.icon,
                          size: new google.maps.Size(71, 71),
                          origin: new google.maps.Point(0, 0),
                          anchor: new google.maps.Point(17, 34),
                          scaledSize: new google.maps.Size(25, 25)
            };


            // Create a marker for each place.
            var marker = new google.maps.Marker({
                                                  map: map,
                                                icon: image,
                                                title: place.name,
                                                position: place.geometry.location
            });
            placeMarkers.push(marker);

            bounds.extend(place.geometry.location);
          }; // End of for loop

          map.fitBounds(bounds);
        }); /* End of region_getplaces*/



        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();
          searchBox.setBounds(bounds);
        });





        /* animated function w/ time out */
        
        /* Calculate distance between current loactio and searched place */
        /*
        Object.size = function(obj) {
          var size = 0, key;
          for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
          }
          return size;
        };


        function closestPlaces(i,placelist,radius){
          var closePlaces = [];
          var size = Object.size(placelist);

          for (var p=0; p < size; p++){
            var dist = google.maps.geometry.spherical.computeDistanceBetween(i,places[p]);
            console.log(dist);

            if  (dist < radius){
              closePlaces.push(placelist[p]);
            }
          }

          return closePlaces;
        }

        */

        function moveTheCar(myMarker, myRoute,i){

          if(i < myRoute.length){
            myMarker.setPosition(myRoute[i]);
           
            window.setTimeout(function(){
              moveTheCar(myMarker,myRoute,i+1);
            },10);
          } 
        }// End of moveThecar 


    } /* End of initilaize */

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>

  </head>

  <body>
      <input id="pac-input" class="controls" type="text" placeholder="Search Box">

   <div id="map-canvas"></div>
    <div class="container-fluid" id="main">

      <div class="row"> 
       <div class="col-md-10 col-lg-10"> <!--map-canvas will be postioned here--></div>
       <div class="col-md-2 col-lg-2" id="left">
          <h2>Connected Car Challenge</h2>
          <p> Animated map </p>
          <br>

          
           <!-- Use jQery template -->
          <legend> Select interested route</legend>
          <select multiple="multiple">
            <optgroup label="VID:38">
              <option value="465">465</option>
              <option value="466">466</option>
              <option value="468">468</option>
              <option value="469">469</option>
              <option value="470">470</option>
            <optgroup label="VID:53">
          </select>


       </div>
      </div> <!-- End of row -->
    </div> <!-- End of Container -->
    

    <!-- Add jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <!-- Add bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script> 

    <!-- Add multiple select form JS -->
    <script src="src/jquery.multiple.select.js"></script>

  </body>
</html>




<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta charset="utf-8">

    <title>Connected Car: VID 38 on the road </title>
    <!-- Add bootstrap -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.css" />

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />


    <!-- Customized CSS -->
    <link href="src/multiple-select.css" rel="stylesheet"/>
    <!-- ref: http://www.bootply.com/FkGBM2gvKt -->
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      
      #map-canvas { 
        /* height: 100%  */
        width:82.6333%;
        height:100%;
        position:absolute;
        left:0px;
        /* top:50px; */
        bottom:0;
        overflow:hidden;
      }
      
      #pac-input {
        background-color: #fff;
        padding: 0 11px 0 13px;
        width: 400px;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        text-overflow: ellipsis;
      }
    
      #pac-input:focus {
        border-color: #4d90fe;
        margin-left: -1px;
        padding-left: 14px;  /* Regular padding-left + 1. */        
        width: 401px;
      }
      

      
      .pac-container {
        font-family: Roboto;
      }
      
      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }

      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
    </style>

   
    <!-- Add Google map API-->
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyAp1w_hIM2WIqXnf0j0Dk4hGBfgZHsIdKA&libraries=places,geometry">
    </script>

    <script type="text/javascript"> /* Google map setting */
      function initialize() {
      
        var mapOptions = {
            center: new google.maps.LatLng(42.518, -83.644),
            zoom: 10
        };

        var map = new google.maps.Map(document.getElementById("map-canvas"),
                      mapOptions);

        /* Data preparation
        * Read gps data from a JSON file 
        */
        var data={};
        var savedRoute ={};
        function loadJSON(filepath){
          return $.getJSON(filepath).done(function(data){
             return data.items;
          })
        };

       var gps38 = "https://dl.dropboxusercontent.com/u/6964160/gps38AllRoute.json";

        var vid_tripid = {};
               vid_tripid['38'] = [465, 466, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 480, 481, 482, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 509, 510, 511, 513, 514, 515, 516, 518, 519, 520, 521, 522, 523, 524, 525, 526, 528, 529, 530, 531, 532, 533, 534, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550];
        
        

        /* Moving Car */

        var carMarker = new google.maps.Marker({
          position: new google.maps.LatLng(42.313797, -83.211242), // park at Ford headquarter
          map: map,
          icon: 'src/img/car-icon.png'
        });

        function moveTheCar(myMarker, myRoute,i){

          if(i < myRoute.length){
            myMarker.setPosition(myRoute[i]);
           
            window.setTimeout(function(){
              moveTheCar(myMarker,myRoute,i+1);
            },10);
          } 
        }// End of moveThecar 



        var paths = {};
        var polys = {};
        var startMarkers ={};
        var openedwindow;
        var colors;

        function addSelRoute(checkedRoute){          
          loadJSON(gps38).done(function(obj){
            console.log(obj);
            var googleLatlng = [];  
            // Convert into google map latLng
            for (var i=0, point; point = obj[checkedRoute]['steps'][i]; i++ ){
              if (i < obj[checkedRoute]['steps'].length){
                var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                googleLatlng.push(latLng);              
              }
            };

            startPoint = obj[checkedRoute]['steps'][0];
            var tripinfo = (checkedRoute + ": " + obj[checkedRoute]['startDate'] + ", " + obj[checkedRoute]['startTime'] ); 

            savedRoute[checkedRoute] = {};
            savedRoute[checkedRoute]['tripid'] = checkedRoute;
            savedRoute[checkedRoute]['steps'] = googleLatlng;
            savedRoute[checkedRoute]['tripinfo'] = tripinfo;
            //savedRoute[checkedRoute]['startPoint'] = startPoint;


            /*
            var startMarker = new google.maps.Marker({
              position: googleLatlng[0],
              map: map,

            });
            */

            var startMarker = setMarker(googleLatlng[0]);
            startMarker.setMap(map);

            var endMarker = setMarker(googleLatlng[googleLatlng.length-1], "finish");
            endMarker.setMap(map);
  

            var infowindow =  new google.maps.InfoWindow({
              content: tripinfo
            });

            infowindow.open(map,startMarker);

            /*
            var endMarker = new google.maps.Marker({
              position: googleLatlng[googleLatlng.length-1],
              map: map,
              icon:"src/img/finish.png"

            });
*/

           
            
            var poly = new google.maps.Polyline({
              path: googleLatlng,
              geodesic: true,
              strokeColor: '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6),
              strokeOpacity: 0.7,
              strokeWeight: 3,
              map: map,      
            }); 

            google.maps.event.addListener(poly, 'mouseover', function() {
            //change color here when mouse over
              poly.setOptions({strokeOpacity:1, strokeWeight: 5})               
            });

            google.maps.event.addListener(poly, 'mouseout', function() {
            //change color here when mouse over
              poly.setOptions({strokeOpacity: 0.5,
                                strokeWeight: 3})               
            });

            google.maps.event.addListener(poly, 'click', function() {
              moveTheCar(carMarker,googleLatlng,0);
              infowindow.open(map,startMarker);
     
            });


            paths[checkedRoute] = googleLatlng;
            startMarkers[checkedRoute] = startMarker;
            polys[checkedRoute] = poly;
            openedwindow = (infowindow);

            console.log("added route - Inside?");
            console.log(savedRoute);
            console.log(paths);

             google.maps.event.addListener(startMarker, 'click', function() {
              moveTheCar(carMarker,googleLatlng,0);
              infowindow.open(map,startMarker);
             });
          

         


          });// End of loadJSON    

    
        }; //End of saveSelRoute


        function rmSelRoute(uncheckedRoute){
          delete savedRoute[uncheckedRoute];
          polys[uncheckedRoute].setMap(null);
          startMarkers[uncheckedRoute].setMap(null);
          
        };


        function addSelVID(checkedVID){

          var tripids = vid_tripid[checkedVID];
          var paths_vid = [];
          loadJSON(gps38).done(function(obj){
            for (var r=0; r < tripids.length; r++){
              // Create google map latLng for each route(trip)
              var tripid = tripids[r];
              var googleLatlng = [];  
              
              for (var i=0, point; point = obj[tripid]['steps'][i]; i++ ){
                if (i < obj[tripid]['steps'].length){
                  var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                  googleLatlng.push(latLng);              
                }; 
              };// Loop thru all steps within a route


              var path = new google.maps.Polyline({
                path: googleLatlng,
                geodesic: true,
                strokeColor: '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6),
                strokeOpacity: 0.7,
                strokeWeight: 3,
                map: map,      
              }); 



              paths_vid.push(new myPathClass(path))





            }// Loop thru all routes within a VID

          }) //End of loadJSON

          
        } // End of addSelVID




        function myPathClass(polyline){
          this.polyline = polyline;  // ???

          var route = polyline.getPath().j;

          if(route[0]){
            var startPoint = new google.maps.LatLng(route[0].k,route[0].B);
            var endPoint = new google.maps.LatLng(route[route.length-1].k, route[route.length-1].B);
            console.log(endPoint);
          }
          
          if(startPoint){
             var startMark = setMarker(startPoint);
          }

          if(endPoint){
            var endMark = setMarker(endPoint, "finish");
          }

          

          /*
          var start = new google.maps.Marker({
               position: new google.maps.Marker(Number(route[0].k), Number(route[0].B)),
               title: "Start"
          });
          */
          
          //console.log(start);

          //var startPoint = route[0];

          google.maps.event.addListener(polyline, 'mouseover', function() {
            polyline.setOptions( { strokeOpacity : 1,
                                   strokeWeight: 5 } );
            startMark.setMap(map);
            endMark.setMap(map);

          });

          google.maps.event.addListener(polyline, 'mouseout', function() {
            polyline.setOptions( { strokeOpacity : 0.7,
                                  strokeWeight: 3 } );

            startMark.setMap(null);
            endMark.setMap(null);

            });

            //start.setMap(null);

        }; // End of myPathClass


        function setMarker(point, type){
          var marker = new google.maps.Marker({
              position: point,
          });

          switch(type){
            case 'finish':
              marker.setIcon('src/img/finish.png');
              break;


          }

          return marker;
        }


        /* Selected VID and/or route
        /* jQuery template: http://wenzhixin.net.cn/p/multiple-select/docs 
        */
        $("select").multipleSelect({
          
          filter: true,
          multiple: true,
          width: '100%',
          placeholder: "Select VID and route",

          onClick: function(view){
            // TODO: fet VID by tripid?????
            
            if (view.checked) {

              console.log(view.value);

              addSelRoute(view.value);
              openedwindow.close();
              
              //showSelinfo(view.value);
              } 
            else{
              rmSelRoute(view.value);
            };

            //console.log((view.value));
            //showSelectedRoute(view.value);
            console.log("what's saved 1");
            console.log(savedRoute);
            


          }, // End of onClick

          onOptgroupClick: function(view) {
              var values = $.map(view.children, function(child){
                  return child.value;
              }).join(', ');

              //console.log(values);
              //console.log(view);

              
              console.log(typeof(view.label));
              var vid = view.label.substring(5,view.label.length);
              //var vid = label
              
              addSelVID(vid);

          }


            //showSelectedRoute(checkedRoute);
         });

        


        /* Add search box */

        var input = /** @type {HTMLInputElement} */(document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
        
        var searchBox = new google.maps.places.SearchBox(/** @type {HTMLInputElement} */(input));

        // [START region_getplaces]
        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
       

        google.maps.event.addListener(searchBox, 'places_changed', function() {
          var places = searchBox.getPlaces();   // an object
          var placeMarkers = [];


          if (places.length == 0) {
            return;
          }
          
          for (var i = 0, marker; marker = placeMarkers[i]; i++) {
            marker.setMap(null);
          }

          // For each place, get the icon, place name, and location.

          placeMarkers = [];
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            var image = {
                          url: place.icon,
                          size: new google.maps.Size(71, 71),
                          origin: new google.maps.Point(0, 0),
                          anchor: new google.maps.Point(17, 34),
                          scaledSize: new google.maps.Size(25, 25)
            };


            // Create a marker for each place.
            var marker = new google.maps.Marker({
                                                  map: map,
                                                icon: image,
                                                title: place.name,
                                                position: place.geometry.location
            });
            placeMarkers.push(marker);

            bounds.extend(place.geometry.location);
          }; // End of for loop

          map.fitBounds(bounds);
        }); /* End of region_getplaces*/



        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();
          searchBox.setBounds(bounds);
        });





        /* animated function w/ time out */
        
        /* Calculate distance between current loactio and searched place */
        /*
        Object.size = function(obj) {
          var size = 0, key;
          for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
          }
          return size;
        };


        function closestPlaces(i,placelist,radius){
          var closePlaces = [];
          var size = Object.size(placelist);

          for (var p=0; p < size; p++){
            var dist = google.maps.geometry.spherical.computeDistanceBetween(i,places[p]);
            console.log(dist);

            if  (dist < radius){
              closePlaces.push(placelist[p]);
            }
          }

          return closePlaces;
        }

        */

        


    } /* End of initilaize */

      google.maps.event.addDomListener(window, 'load', initialize);


    </script>

  </head>

  <body>
      <input id="pac-input" class="controls" type="text" placeholder="Search Box">

   <div id="map-canvas"></div>
    <div class="container-fluid" id="main">

      <div class="row"> 
       <div class="col-md-10 col-lg-10"> <!--map-canvas will be postioned here--></div>
       <div class="col-md-2 col-lg-2" id="left">
          <h2>Connected Car Challenge</h2>
          <p> Animated map </p>
          <br>

          
           <!-- Use jQery template -->
          <legend> Select interested route</legend>
          <select multiple="multiple">
            <optgroup label="VID:38">
              <script language="javascript">
               var vid_tripid = {};
               vid_tripid['38'] = [465, 466, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 480, 481, 482, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 509, 510, 511, 513, 514, 515, 516, 518, 519, 520, 521, 522, 523, 524, 525, 526, 528, 529, 530, 531, 532, 533, 534, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550];

                for (var i=0; i<vid_tripid['38'].length; i++){
                  document.write("\<option value=\""+vid_tripid['38'][i]+"\"\>" + vid_tripid['38'][i] + "\<\/option\>" );
                };
              </script>
              <option value="465">465</option>
              <option value="466">466</option>
              <option value="468">468</option>
              <option value="469">469</option>
              <option value="470">470</option>
            <optgroup label="VID:53">
          </select>


       </div>
      </div> <!-- End of row -->
    </div> <!-- End of Container -->
    

    <!-- Add jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <!-- Add bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script> 

    <!-- Add multiple select form JS -->
    <script src="src/jquery.multiple.select.js"></script>

  </body>
</html>




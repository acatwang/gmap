<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta charset="utf-8">

    <title>Connected Car: VID 38 on the road </title>
    <!-- Add bootstrap -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.css" />

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />


    <!-- Customized CSS -->
    <link href="src/multiple-select.css" rel="stylesheet"/>
    <!-- ref: http://www.bootply.com/FkGBM2gvKt -->
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      
      #map-canvas { 
        /* height: 100%  */
        width:82.6333%;
        height:100%;
        position:absolute;
        left:0px;
        /* top:50px; */
        bottom:0;
        overflow:hidden;
      }
      
      #pac-input {
        background-color: #fff;
        padding: 0 11px 0 13px;
        width: 400px;
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
        text-overflow: ellipsis;
      }
    
      #pac-input:focus {
        border-color: #4d90fe;
        margin-left: -1px;
        padding-left: 14px;  /* Regular padding-left + 1. */        
        width: 401px;
      }
      

      
      .pac-container {
        font-family: Roboto;
      }
      
      #type-selector {
        color: #fff;
        background-color: #4d90fe;
        padding: 5px 11px 0px 11px;
      }

      #type-selector label {
        font-family: Roboto;
        font-size: 13px;
        font-weight: 300;
      }
    </style>

   
    <!-- Add Google map API-->
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyAp1w_hIM2WIqXnf0j0Dk4hGBfgZHsIdKA&libraries=places,geometry">
    </script>

    <script type="text/javascript"> /* Google map setting */
      function initialize() {
      
        geocoder = new google.maps.Geocoder();
        var mapOptions = {
            center: new google.maps.LatLng(42.518, -83.644),
            zoom: 10
        };

        var map = new google.maps.Map(document.getElementById("map-canvas"),
                      mapOptions);

        /* Data preparation
        * Read gps data from a JSON file 
        */
        var data={};
        var savedRoute ={};
        function loadJSON(filepath){
          return $.getJSON(filepath).done(function(data){
             return data.items;
          })
        };

       var gps38 = "https://dl.dropboxusercontent.com/u/6964160/gps38AllRoute.json";
       var allroute = "https://dl.dropboxusercontent.com/u/6964160/allRoute.json";

        var vid_tripid = {};
               vid_tripid['38'] = [465, 466, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 480, 481, 482, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 509, 510, 511, 513, 514, 515, 516, 518, 519, 520, 521, 522, 523, 524, 525, 526, 528, 529, 530, 531, 532, 533, 534, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550];
        
              vid_tripid['53'] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 20, 21, 22, 23, 24, 25, 26, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 61, 62, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 98, 99, 100, 101, 102, 103, 104, 106, 107, 108, 109, 110, 111, 112, 113, 114, 117, 118, 119, 120, 123, 124, 125, 126, 127, 128, 130, 131, 132, 133];

        var vid_cartype ={};
        vid_cartype['38'] = "explorer";
        vid_cartype['53'] = "fusion";


        /* Moving Car */

        function moveTheCar(myMarker, myRoute,i){
          if(i < myRoute.length){           
            myMarker.setPosition(myRoute[i]);           
            window.setTimeout(function(){
              moveTheCar(myMarker,myRoute,i+1);
            },10);
          } 


        };// End of moveThecar 



        var paths = {};
        var polys = {};
        var startMarkers_r ={};
        var endMarkers_r ={};
        var openedwindow;
        var opendedPlaceInfo;
        var colors;

        function addSelRoute(checkedRoute){          
          loadJSON(allroute).done(function(obj){
            var googleLatlng = [];  
            // Convert into google map latLng
            for (var i=0, point; point = obj[checkedRoute]['steps'][i]; i++ ){
              if (i < obj[checkedRoute]['steps'].length){
                var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                googleLatlng.push(latLng);              
              }
            };

            startPoint = obj[checkedRoute]['steps'][0];
            var tripinfo = (checkedRoute + ": " + obj[checkedRoute]['startDate'] + ", " + obj[checkedRoute]['startTime'] ); 


            var startMarker = setMarker(googleLatlng[0]);
            startMarker.setMap(map);
            startMarkers_r[checkedRoute] = startMarker;


            var endMarker = setMarker(googleLatlng[googleLatlng.length-1], "finish");
            endMarker.setMap(map);
            endMarkers_r[checkedRoute] = endMarker;
  

            var infowindow =  new google.maps.InfoWindow({
              content: tripinfo
            });

            infowindow.open(map,startMarker);

            //map.panToBounds(googleLatlng[0], googleLatlng[googleLatlng.length-1]);

         
            
            var poly = new google.maps.Polyline({
              path: googleLatlng,
              geodesic: true,
              strokeColor: '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6),
              strokeOpacity: 0.7,
              strokeWeight: 3,
              map: map,      
            }); 

            myPathClass(poly, 'explorer'); // ???how to get vehicle type
            
            polys[checkedRoute] = poly;
            
            paths[checkedRoute] = googleLatlng;
            

            openedwindow = (infowindow);


             google.maps.event.addListener(startMarker, 'click', function() {
              //moveTheCar(carMarker,googleLatlng,0);
              infowindow.open(map,startMarker);
             });
          

            /* return location? */
            geocoder.geocode({'latLng': googleLatlng[googleLatlng.length-1]},function(results, status) {
              if (status == google.maps.GeocoderStatus.OK) {
                 if (results[0]) {
                   map.setZoom(11);

                   if(isNaN(Number(results[0].address_components[0].long_name[0]))){
                     var placeinfo =  new google.maps.InfoWindow({
                      //content: results[1].formatted_address
                      //content: results[0].formatted_address
                      content: results[0].address_components[0].long_name
                     });
                     placeinfo.open(map, endMarker);
                     opendedPlaceInfo = placeinfo;
                  } else{
                    var placeinfo =  new google.maps.InfoWindow({
                      //content: results[1].formatted_address
                      content: results[0].formatted_address
                     
                     });
                    placeinfo.open(map, endMarker);
                    opendedPlaceInfo = placeinfo;


                   console.log( results[0]);
                  }
                  
                 } else{
                   alert('result 1'+ results[1]);
                 }
              }

            }) // end of geocode


          });// End of loadJSON        
        }; //End of saveSelRoute


        function rmSelRoute(uncheckedRoute){
          polys[uncheckedRoute].setMap(null);
          startMarkers_r[uncheckedRoute].setMap(null);
          endMarkers_r[uncheckedRoute].setMap(null);
        };

        var paths_vid = [];
        function addSelVID(checkedVID){

          var tripids = vid_tripid[checkedVID];

          var top_left_X = 42.5;
          var top_left_Y = -83;
          var down_right_X = 42.5;
          var down_right_Y = -83;
          
          loadJSON(allroute).done(function(obj){
            for (var r=0; r < tripids.length; r++){
              // Create google map latLng for each route(trip)
              var tripid = tripids[r];
              var googleLatlng = [];  
              
              for (var i=0, point; point = obj[tripid]['steps'][i]; i++ ){
                if (i < obj[tripid]['steps'].length){

                  var latLng = new google.maps.LatLng(point['lat'],point['lon']);
                  googleLatlng.push(latLng);              
                }; 
              };// Loop thru all steps within a route

              var tripinfo = (tripid + ": " + obj[tripid]['startDate'] + ", " + obj[tripid]['startTime'] ); 

              var path = new google.maps.Polyline({
                path: googleLatlng,
                geodesic: true,
                strokeColor: '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6),
                strokeOpacity: 0.7,
                strokeWeight: 3,
                map: map,      
              }); 

              myPathClass(path, vid_cartype[checkedVID], tripinfo);


              paths_vid.push(path);

            }// Loop thru all routes within a VID

          }) //End of loadJSON

        }; // End of addSelVID


        function rmSelVID(uncheckedVID){
          for (var i=0; i < paths_vid.length; i++){
            paths_vid[i].setMap(null);
          }
        }


        function myPathClass(polyline, cartype, tripinfo){
          this.polyline = polyline;  // ???

          var route = polyline.getPath().j;

          if(route[0]){
            var startPoint = new google.maps.LatLng(route[0].k,route[0].B);
            var endPoint = new google.maps.LatLng(route[route.length-1].k, route[route.length-1].B);
          }
          
          if(startPoint){
             var startMark = setMarker(startPoint);
          }

          if(endPoint){
            var endMark = setMarker(endPoint, "finish");
          }

          if(tripinfo){
            var tripInfoWindow = new google.maps.InfoWindow({
              content: tripinfo
            });
          }


          google.maps.event.addListener(polyline, 'mouseover', function() {
            polyline.setOptions( { strokeOpacity : 1,
                                   strokeWeight: 5 } );
            startMark.setMap(map);
            endMark.setMap(map);
            caldistance(route);
            tripInfoWindow.open(map, startMark);

          });

          google.maps.event.addListener(polyline, 'mouseout', function() {
            polyline.setOptions( { strokeOpacity : 0.7,
                                  strokeWeight: 3 } );

            startMark.setMap(null);
            endMark.setMap(null);

            if(targetMarkers.length > 0) {

              for (var i=0; i < targetMarkers.length; i ++){
                targetMarkers[i].setMap(null);
              }
            };

          });

           google.maps.event.addListener(polyline, 'click', function() {
              startMark.setMap(map);
              endMark.setMap(map);
              var car = setMarker(startPoint,cartype);
              car.setMap(map);

              moveTheCar(car,route,0);
              console.log(endPoint);
           });
          

        }; // End of myPathClass


        function setMarker(point, type){
          var marker = new google.maps.Marker({
              position: point,
          });

          switch(type){

            case 'finish':
              marker.setIcon('src/img/finish.png');
              break;

            case 'explorer':
              marker.setIcon('src/img/explorer_icon.png');
              break;

            case 'fusion':
              marker.setIcon('src/img/fusion_icon.png');
              break;

            case 'select':
              marker.setIcon('src/img/select.png');
              break;

          }

          return marker;
        }


        /* Selected VID and/or route
        /* jQuery template: http://wenzhixin.net.cn/p/multiple-select/docs 
        */
        $("select").multipleSelect({
          
          filter: true,
          multiple: true,
          width: '100%',
          placeholder: "Select VID and route",
          selectAll: false,
          multipleWidth: 50,

          onClick: function(view){
            // TODO: fet VID by tripid?????
            
            if (view.checked) {

              console.log(view.value);

              addSelRoute(view.value);
              openedwindow.close();
              opendedPlaceInfo.close();

              //showSelinfo(view.value);
              } 
            else{
              rmSelRoute(view.value);
            };

            //console.log((view.value));
            //showSelectedRoute(view.value);



          }, // End of onClick

          onOptgroupClick: function(view) {     
              console.log(typeof(view.label));

              var vid = view.label.substring(5,view.label.length);
              
              if(view.checked) {
                addSelVID(vid); }
              else{
                rmSelVID(vid);
              };

          } // End of onOptgroupclick
            //showSelectedRoute(checkedRoute);


         }); // End of multiselect event

        $("#uncheckAllBtn").click(function(){

          for (var i=0; i < paths_vid.length; i++){
            paths_vid[i].setMap(null);
          };

          for (var k in polys){
            polys[k].setMap(null);
            startMarkers_r[k].setMap(null);
            endMarkers_r[k].setMap(null);
          };

          $("select").multipleSelect("uncheckAll");
        });

        $(":checkbox").change(function(){
          if(this.checked){
            addSelVID($(this).val());
            console.log($(this).val());
          }
          else{
            rmSelVID($(this).val());
          }
        })


        /* Add search box */

        var input = /** @type {HTMLInputElement} */(document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
        
        var searchBox = new google.maps.places.SearchBox(/** @type {HTMLInputElement} */(input));

        var placelist = [];

        // [START region_getplaces]
        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
       var placeMarkers = [];
        google.maps.event.addListener(searchBox, 'places_changed', function() {
          
          var places = searchBox.getPlaces();   // an object
          //var placeMarkers = [];


          if (places.length == 0) {
            return;
          }
          
          for (var i = 0, marker; marker = placeMarkers[i]; i++) {
            marker.setMap(null);
          }

          // For each place, get the icon, place name, and location.

          
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            placelist.push(place);

            var image = {
                          url: place.icon,
                          size: new google.maps.Size(71, 71),
                          origin: new google.maps.Point(0, 0),
                          anchor: new google.maps.Point(17, 34),
                          scaledSize: new google.maps.Size(25, 25)
            };


            // Create a marker for each place.
            var marker = new google.maps.Marker({
                                                  map: map,
                                                icon: image,
                                                title: place.name,
                                                position: place.geometry.location
            });
            placeMarkers.push(marker);

            bounds.extend(place.geometry.location);
            //console.log(place);
            //console.log(place.geometry.location);

          }; // End of for loop

          caldistance();

          map.fitBounds(bounds);

        }); /* End of region_getplaces*/


        targetMarkers = [];
        function caldistance(potentialRoute){
          var radius = 800; // meters

          var closePlacesId = [];
          var closeStepId = [];
          
          var closestID = [];
          var closestDistToRoute =[];
          
          if (placelist.length > 0){
            for (var j=0; j<placelist.length; j++){
              var distances = [];
              var closest = -1;             
              
              var directDist = 0;
              for (var i=0; i <potentialRoute.length; i++){ 

                var dist =  google.maps.geometry.spherical.computeDistanceBetween(potentialRoute[i], placelist[j].geometry.location);  // return meter
                distances[i] = dist;

                if (directDist == 0 || dist < directDist ){
                  directDist = dist;
                }

                /*
                // Find the closest distance between every store and routes
                if (closest == -1 || dist < distances[closest] ){
                  closest = i;
                };
                */
             
              }; // loop thru points in a route

              //closestID.push(closest);
              //closestDistToRoute.push(distances[closest]);
              console.log(j);
              console.log(directDist);
              closestDistToRoute.push(directDist);
            
            }; // loop thru places in placelist

            for (var i=0; i < closestDistToRoute.length; i++){
              if(closestDistToRoute[i] < radius ){
                console.log(closestDistToRoute[i]);
                closePlacesId.push(i);
              }

            };


            if (closePlacesId.length > 0){
              for (var p =0; p < closePlacesId.length; p++){
                var id = closePlacesId[p];
                var closetTarget = setMarker(placelist[id].geometry.location, 'select');
                targetMarkers.push(closetTarget);
                var targetInfo = "<p>" + placelist[id].name + "</p>" +
                              "<p> Distance: " + Math.round(closestDistToRoute[id] * 100) / 100 + "</p>"; // rounded to two decimal

                var targetWindow = new google.maps.InfoWindow({
                  content: targetInfo
                });
                closetTarget.setMap(map);
                targetWindow.open(map, closetTarget);
              }
            };

            /*
            var theClosest = closestDist.indexOf(Math.min.apply(Math, closestDist));

            console.log(theClosest);

            var closetTarget = setMarker(placelist[theClosest].geometry.location);
            var targetInfo = "<p>" + placelist[theClosest].name + "</p>" +
                              "<p> Distance: " + Math.round(closestDist[theClosest] * 100) / 100 + "</p>"; // rounded to two decimal

            var targetWindow = new google.maps.InfoWindow({
               content: targetInfo
            });
            closetTarget.setMap(map);
            targetWindow.open(map, closetTarget);

            */
          };

        }; // End of caldistance

        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();
          searchBox.setBounds(bounds);
        });





        /* animated function w/ time out */
        
        /* Calculate distance between current loactio and searched place */
        /*
        Object.size = function(obj) {
          var size = 0, key;
          for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
          }
          return size;
        };


        function closestPlaces(i,placelist,radius){
          var closePlaces = [];
          var size = Object.size(placelist);

          for (var p=0; p < size; p++){
            var dist = google.maps.geometry.spherical.computeDistanceBetween(i,places[p]);
            console.log(dist);

            if  (dist < radius){
              closePlaces.push(placelist[p]);
            }
          }

          return closePlaces;
        }

        */

        


    } /* End of initilaize */

      google.maps.event.addDomListener(window, 'load', initialize);


    </script>

  </head>

  <body>
    <input id="pac-input" class="controls" type="text" placeholder="Search Box">

   <div id="map-canvas"></div>
    <div class="container-fluid" id="main">

      <div class="row"> 
       <div class="col-md-10 col-lg-10"> <!--map-canvas will be postioned here--></div>
       <div class="col-md-2 col-lg-2" id="left">
          <h2>Connected Car Challenge</h2>
          <p> Animated map </p>
          <br>

          
          <legend> Select VID </legend>
          <label class="checkbox-inline">
            <input type="checkbox" id="inlineCheckbox1" value="38"> 38
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="inlineCheckbox2" value="53"> 53
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="inlineCheckbox3" value="89"> 89
          </label>
          <br>
          <br>


           <!-- Use jQery template -->
          <legend> Select route</legend>
          <select multiple="multiple">

            <optgroup label="VID:38">
              <script language="javascript">
               var vid_tripid = {};
               vid_tripid['38'] = [465, 466, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 480, 481, 482, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 509, 510, 511, 513, 514, 515, 516, 518, 519, 520, 521, 522, 523, 524, 525, 526, 528, 529, 530, 531, 532, 533, 534, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550];

                for (var i=0; i<vid_tripid['38'].length; i++){
                  document.write("\<option value=\""+vid_tripid['38'][i]+"\"\>" + vid_tripid['38'][i] + "\<\/option\>" );
                };
              </script>
             
            <optgroup label="VID:53">
              <script>

                var vid_tripid ={}; 
                  vid_tripid['53'] = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 20, 21, 22, 23, 24, 25, 26, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 61, 62, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 98, 99, 100, 101, 102, 103, 104, 106, 107, 108, 109, 110, 111, 112, 113, 114, 117, 118, 119, 120, 123, 124, 125, 126, 127, 128, 130, 131, 132, 133];

                for (var i=0; i<vid_tripid['53'].length; i++){
                    document.write("\<option value=\""+vid_tripid['53'][i]+"\"\>" + vid_tripid['53'][i] + "\<\/option\>" );
                };
              </script>



          </select>

          <br>
          <br>

          <button id="uncheckAllBtn" class="btn btn-default pull-right"><span class="glyphicon glyphicon-remove"></span>Clear All</button>

       </div>
      </div> <!-- End of row -->
    </div> <!-- End of Container -->
    

    <!-- Add jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <!-- Add bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script> 

    <!-- Add multiple select form JS -->
    <script src="src/jquery.multiple.select.js"></script>

  </body>
</html>



